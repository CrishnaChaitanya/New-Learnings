SELECT 
    COUNT(DISTINCT 
        CASE 
        WHEN JSON_EXTRACT(message, '$.details.stepName') = 'copy' 
        THEN JSON_EXTRACT(message, '$.transferDetails.username')
        END
    ) AS FileUploadUsers,
    COUNT(DISTINCT 
        CASE 
        WHEN message LIKE '%CONNECTED%' 
        THEN SUBSTRING(message FROM 'User=([^ ]+)')
        END
    ) AS InfraOnlyUsers
FROM logs
WHERE 
    (JSON_VALID(message) AND JSON_EXTRACT(message, '$.details.stepName') = 'copy')
    OR 
    message LIKE '%CONNECTED%'
