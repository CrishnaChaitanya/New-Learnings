fields @timestamp, @message
| filter (
    (parse_json(@message).transferDetails.username is not null and 
     parse_json(@message).details.stepName = 'copy') or 
    (strcontains(@message, 'CONNECTED'))
)
| compute (
    count_distinct(
        if(parse_json(@message).transferDetails.username is not null and 
           parse_json(@message).details.stepName = 'copy', 
           parse_json(@message).transferDetails.username,
           null)
    ) as FileUploadUsers,
    count_distinct(
        if(strcontains(@message, 'CONNECTED'), 
           split(filter(@message, 'User=')[0], ' ')[1],
           null)
    ) as InfraOnlyUsers
)
| sort @timestamp desc
| limit 10
