fields @timestamp, @message
| filter (
    (isValidJson(@message) and 
     parse_json(@message).transferDetails.username is not null and 
     parse_json(@message).details.stepName = 'copy') or 
    (strcontains(@message, 'CONNECTED SourceIP='))
)
| parse (
    case 
    when isValidJson(@message) 
    then parse_json(@message).transferDetails.username
    when strcontains(@message, 'CONNECTED')
    then trim(substring(@message, strpos(@message, 'User=') + 5))
    else null
    end as username
)
| stats 
    count_distinct(case when parse_json(@message).details.stepName = 'copy' then username else null end) as FileUploadUsers,
    count_distinct(case when strcontains(@message, 'CONNECTED') then username else null end) as InfraOnlyUsers
| sort @timestamp desc
